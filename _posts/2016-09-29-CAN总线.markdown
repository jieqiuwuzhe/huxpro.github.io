---
layout:     post
title:      "CAN总线"
subtitle:   " \"CAN总线相关介绍 \""
date:       2016-09-29 08:57:00
author:     "Root"
header-img: "img/contact-bg.jpg"
catalog: true
tags:
    - 单片机
---

> “亡命天涯，只是为了追寻你的足迹。却不想命运的捉弄，总是让你我天各一方。————法外狂徒 ”

# CAN总线介绍

## CAN总线相关概念

CAN总线是一种串行通信协议，广泛应用于汽车电子及船舶等领域，两根线，CAN-H 和 CAN-L 的电位差来确定总线电平。任意时刻总线上都有两种电平：显性电平和隐性电平。连接在总线上的所有单元均能够发送信息，若有超过一个单元在同一时刻发送信息，则具有最高优先级的单元获得发送资格，其他所有单元执行接收操作。

![Markdown](http://p1.bpimg.com/572619/f1bc6f814146e268.jpg)

## CAN总线特点

1、多主控制：总线空闲时，连接到总线上所有单元均可以启动发送信息。先占有总线的设备获得发送信息的资格，若同时开始发送信息，则优先级高的一方获得发送资格。

2、信息发送控制：多个设备同时启动发送时，通过ID号的每一位来进行竞争，赢得竞争（优先级高）的设备继续发送。

3、系统灵活性：总线上的单元并没有类似于地址这样的标识，所以添加或删除一个设备无需更改软件或硬件，或其他设备的应用层程序。

4、通信速度：可设置任何通信速度，适应网络规模，但同一网络内所有单元速度必须相同。

5、远程数据请求：可通过发送“遥控帧”，请求其他单元发送数据。

6、错误检测、错误通知、错误恢复、错误隔离：所有单元均可以检测出错误，检测到错误后会立即同时通知其他所有单元（错误通知），若一个单元发送信息时检测到一个错误，会强制终止信息传输，并通知其他所有设备发生了错误。然后他会重传直到信息正常传输出去（错误恢复）。CAN总线上有两种类型的错误：暂时性错误（噪声影响）与永久性错误（设备出错等），CAN可以区别这两种类型错误，一方面减低优先级阻止其对其他正常单元的影响，另一方面，如果是持续性错误，则将这个设备从总线上隔离开来。

7、连接：设备的连接数理论上无限制，但是链接数目和通讯速度是反比关系。

## CAN协议基本概念

CAN协议包括OSI模型的传输层、数据链路层、物理层。

![Markdown](http://p1.bpimg.com/572619/0276259f2d457b16.jpg)


# CAN协议介绍

## 1、帧类型

通讯时使用下面五个类型的帧：数据帧、遥控帧、错误帧、过载帧、帧间空隙

这里面数据帧和遥控帧由用户自己定制，其他帧则有CAN总线进行硬件设置。

数据和遥控帧有两种格式，标准和扩展格式。标准格式有11bit的ID，扩展格式有29bit的ID。帧的用处和结构如下：

![Markdown](http://p1.bpimg.com/572619/0e3a0076ff3ec8c2.jpg)

![Markdown](http://p1.bpimg.com/572619/f1aeaa6dbf16acf9.jpg)

![Markdown](http://i1.piimg.com/572619/761daa47866bd95c.jpg)

![Markdown](http://i1.piimg.com/572619/063f8cb3cfdcb592.jpg)

![Markdown](http://i1.piimg.com/572619/0958574632232605.jpg)

## 2、数据帧

数据帧由发送单元使用，用来发送信息给接收单元，是用户操作的基本帧。

数据帧由7个域构成，结构如下：

（1）帧开始（SOF）：这个域表示数据帧的开始。

（2）仲裁域：这个域表示一个帧的优先级

（3）控制域：这个域表示保留位和数据字节数

（4）数据域：这是数据内容，0-8个字节的数据能被发送

（5）CRC域：这个域用于检查帧的传输错误。

（6）ACK域：是对帧已经被正常接收的一个证实。

（7）帧结束：指示数据帧结束

![Markdown](http://i1.piimg.com/572619/bccd1635d497b0cb.jpg)


### 2.1 帧开始（SOF）

指示1帧的开始，由 1 bit显性位组成。

![Markdown](http://p1.bqimg.com/572619/b91559a2fca629b6.jpg)

（显性与隐形：CAN总线在没有节点传输报文时是一直处于隐性状态。当有节点传输报文时显性覆盖隐性，由于CAN总线是一种串行总线，也就是说报文是一位一位的传输的，而且是数字信号（0和1），1代表隐性，0代表显性。在传送报文的过程中是显隐交替的，就像二进制数字0101001等，这样就能把信息发送出去，而总线空闲的时候是一直处于隐性的。）

### 2.2 仲裁域

这个域表示数据优先级别，对于仲裁域，标准格式和扩展格式是有差别的。

![Markdown](http://p1.bqimg.com/572619/047869657dd47564.jpg)

ID:

标准格式的ID有11bit，从ID28到ID18被依次发送，禁止高7位全部为隐形（即禁止ID=1111111xxxx），故共有2^11-2^4=2048-16个ID可被使用。

扩展格式的ID有29bit，基本ID由从ID28到ID18被依次发送，扩展ID由从ID17到ID0被依次发送，同样的禁止高7位全部为隐形（即禁止ID=1111111xxxx），故共有2^29-2^4=536870912-16个ID可被使用。

CAN总线上发送的每一条报文都具有唯一的一个11位或29位数字的ID。CAN总线状态取决于二进制数‘0’而不是‘1’，所以ID号越小，则该报文拥有越高的优先权。因此一个为全‘0’标志符的报文具有总线上的最高级优先权。

### 2.3 控制域

占6个bit，指示要传输的数据字节数。

![Markdown](http://i1.piimg.com/572619/7c297ece2f96478a.jpg)

保留位：r0,r1，保留位必须以显性电平传送，但是接收侧可以接受显性、隐性任意组合的电平。

数据长度码：DLC，对应关系如下，字节数必须是0-8个字节，但DLC=9-15时，接收方并不视为错误。

![Markdown](http://i1.piimg.com/572619/40651c3ccf24ec31.jpg)

### 2.4 数据域

对于标准或扩展，格式是一样的。这个域是传输的数据，可以是0-8个字节，字节数在上述控制域中标明。数据输出开始于MSB。

![Markdown](http://i1.piimg.com/572619/fedded9f4b92cb34.jpg)

### 2.5 CRC域

对标准或扩展格式一样。用来校验。由15 bit CRC码和1 bit 定界符delimiter组成。

![Markdown](http://i1.piimg.com/572619/420b8d45faa85904.jpg)

校验范围：SOF+仲裁域+控制域+数据域。

### 2.6 ACK域

对一帧已被正常接收的一个确认信号，2bit，一个是ACK的slot，一个是ACK的定界符delimiter。

![Markdown](http://i1.piimg.com/572619/3c788dbdffc3a9b5.jpg)

发送单元的ACK：以隐形bit发送 ACK slot和 ACK delimiter。

接收单元的ACK：正确接收到信息的接收单元在接收帧的ACK slot中发送一个显性bit，通知发送单元以正确接收完毕。

### 2.7 帧结束

由7位隐性位组成

![Markdown](http://p1.bqimg.com/572619/973109918cbf1299.jpg)


## 3、遥控帧

遥控帧是接收单元请求发送单元发送一个信息，遥控帧有6个域组成。如图23显示的那样，除了没有数据域外其它与数据帧的结构是一样的。

(1) 帧开始（SOF）：这个域表示数据帧的开始。

(2) 竞争域：这个域表示数据的优先级，具有同样ID的数据帧被请求。

(3) 控制域：这个域表示保留位和数据字节数

(4) CRC域：这个域用于检查帧的传输错误。

(5) ACK域：是对帧已经被正常接收的一个证实。

(6) 帧结束：指示遥控帧的结束

![Markdown](http://p1.bqimg.com/572619/cc0c1ad36b01db47.jpg)

遥控帧和数据帧之间的不同：

遥控帧没有数据域，在仲裁域里的RTR位是隐性电平，而数据帧RTR则为显性的。没有数据的数据帧与遥控帧可以通过RTR为来区分

遥控帧没有数据域，其数据长度码的值表示对应请求的数据帧的数据长度码。

没有数据域的数据帧可以被各单元用来作为周期连接确认/应答，或者仲裁域本身带有实质性信息。

## 4、错误帧

这个帧用来通知在传输期间发生了一个错误，错误帧由一个错误标志和一个错误定界符组成，错误帧由CAN的硬件来发送。

(1) 错误标志：有2种错误标志类型：主动错误和被动错误标志

 a)主动错误标志：6个显性位

 b) 被动错误标志：6个隐性位

(2) 错误定界符：由8个隐性位组成。

![Markdown](http://p1.bpimg.com/572619/b07191b688987a03.jpg)

注1：错误标志重叠：取决于连接到总线上的各单元检测出错误的时间，错误标志可能一个重叠在另一个上，总共可达12bit长度。

注2：主动错误标志：处于主动错误状态的单元检测出错误时输出的错误标志。

注3：被动错误标志：处于被动错误状态的单元检测出错误时输出的错误标志。

## 5、过载帧

当接收单元还没准备好接受帧时，会用过载帧来通知未做好接收准备。由一个过载标志和一个过载定界符组成。

![Markdown](http://p1.bpimg.com/572619/9813c7450dbe56f1.jpg)

(1) 过载标志：由6个显性位组成，过载标志与错误帧的主动错误标志具有相同的结构。

(2) 过载定界符：由8个隐性位组成，过载定界符与错误帧的错误定界符具有相同的结构。

注1：错误标志重叠：向错误标志一样，取决于时间，过载标志可能一个重叠在另一个上，总共可达12bit长度。

## 6、帧间间隔

这个帧用来隔开数据帧和遥控帧。数据和遥控帧可通过插入帧间间隔与前面传输的任何帧（数据帧、遥控帧、错误帧、过载帧）分开。

注意：！**过载帧和错误帧前面不能插入帧间间隔！**

![Markdown](http://p1.bpimg.com/572619/54fe1c159e221592.jpg)

（1）间隔：由3个隐性位组成。在间隔期间如果检测到显性电平，则必须发送过载帧，然而，如果间隔的第3bit是显性电平，间隔被认为是SOF

（2）总线空闲：是隐性电平，长度没有限制（它可以是0bit长）。当总线处于这种状态的时候，总线被认为是自由空闲的，任何单元都可以启动发送信息。

（3）暂停传输（传输暂停期）：有8个隐性位组成。只在处于被动错误状态的单元刚发送一个消息后的帧间隔中包含的段。



—— Root 于 2016.9


